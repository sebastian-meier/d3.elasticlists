//EXTEND SO THAT DATA FIELDS can contain multiple values separated by comma as an option
var elasticLists=function(e){function g(e){m=e;u=m.node().getBoundingClientRect().width/d.columns.length;a=m.node().getBoundingClientRect().height;var t=0;for(v in r){var n=m.append("div").attr("id","head-"+d.columns[t]).attr("class","el-head").attr("style","margin:0; padding:0; float:left; height:"+p+"px; width:"+100/d.columns.length+"%;").append("svg").attr("width",u).attr("height",p);n.append("rect").attr("height",p-5).attr("width",u-10).attr("x",0).attr("y",0);n.append("text").text(d.columns[t]).attr("x",5).attr("y",(p-5)/2+4);t++}t=0;for(v in r){var i=m.append("div").attr("id","list-"+d.columns[t]).attr("data-column",d.columns[t]).attr("class","el-col").attr("style","margin:0; padding:0; float:left; height:"+(a-p)+"px; width:"+100/d.columns.length+"%;"),s=i.append("svg").attr("data-column",d.columns[t]).attr("id","svg-"+d.columns[t]).attr("height",h[t]);s.selectAll("rect.el-row").data(r[v]).enter().append("rect").attr("class",function(e,t){return"el-row el-count-"+e.count}).attr("x",0).attr("width",u-10);s.selectAll("text.el-text-left").data(r[v]).enter().append("text").attr("class",function(e,t){return"el-text el-text-left el-count-"+e.count}).attr("x",5);s.selectAll("text.el-text-right").data(r[v]).enter().append("text").attr("class",function(e,t){return"el-text el-text-right el-count-"+e.count}).attr("text-anchor","end").attr("x",u-15);s.selectAll("rect.el-click").data(r[v]).enter().append("rect").attr("class","el-click").attr("x",0).attr("width",u-10).on("click",function(e,t){g.changeFilter(d3.select(this.parentNode).attr("data-column"),e.name);g.update()});t++}g.update()}function y(e,t){var r=!1;for(f in n[t])e.name==n[t][f]&&(r=!0);return r}function b(e){var t=!0;for(f in n)if(n[f].length>=1){var r=!1;for(i in n[f])if(d.multiples){var s=e[f].split(d.splitStr);for(o in s)s[o]==n[f][i]&&(r=!0)}else e[f]==n[f][i]&&(r=!0);r||(t=!1)}return t}var t={id:"id",columns:[0],duration:500,multiples:!1,splitStr:","},n=[],r=[],s=[],u=0,a=0,l,h=[],p=40,d=d3.tools.extend(t,e);for(var v=0;v<d.columns.length;v++)n[d.columns[v]]=[];var m;g.update=function(){var e=0;for(v in r){d3.select("#svg-"+d.columns[e]).transition().duration(d.duration).attr("height",h[e]);d3.selectAll("#svg-"+d.columns[e]+" rect.el-row").data(r[v]).attr("class",function(e,t){var n="";y(e,d3.select(this.parentNode).attr("data-column"))&&(n="el-selected ");return n+"el-row el-count-"+e.count}).transition().duration(d.duration).attr("y",function(e,t){return e.y}).attr("height",function(e,t){return l(e.count)});d3.selectAll("#svg-"+d.columns[e]+" text.el-text-left").data(r[v]).attr("class",function(e,t){return"el-text el-text-left el-count-"+e.count}).text(function(e,t){return e.name}).transition().duration(d.duration).attr("y",function(e,t){return e.y+l(e.count)/2+4});d3.selectAll("#svg-"+d.columns[e]+" text.el-text-right").data(r[v]).attr("class",function(e,t){return"el-text el-text-right el-count-"+e.count}).text(function(e,t){return e.count+"/"+e.ocount}).transition().duration(d.duration).attr("y",function(e,t){return e.y+l(e.count)/2+4});d3.selectAll("#svg-"+d.columns[e]+" rect.el-click").data(r[v]).transition().duration(d.duration).attr("y",function(e,t){return e.y}).attr("height",function(e,t){return l(e.count)});e++}};g.updateData=function(){for(var e=0;e<d.columns.length;e++){var t=[];for(var n=0;n<d.data.length;n++){var i=d.data[n][d.columns[e]],s=!1;for(c in t)if(t[c].name==i){s=!0;b(d.data[n])&&t[c].count++;t[c].ocount++}if(!s){var o={name:i,count:0,ocount:0,y:0};b(d.data[n])&&(o.count=1);o.ocount=1;t.push(o)}}r[d.columns[e]]=t}for(e in r)r[e].sort(function(e,t){return typeof e.name=="number"&&typeof t.name=="number"?e.name-t.name:e.name>t.name});var u=[];for(e in r)for(ll in r[e])u.push(r[e][ll].ocount);l=d3.scale.linear().domain(d3.extent(u)).range([20,60]);h=[];for(e in r){var a=0;for(ll in r[e]){r[e][ll].y=a;a+=l(r[e][ll].count)+2}h.push(a)}for(var n=0;n<d.data.length;n++)b(d.data[n])?d.data[n].el_selected=!0:d.data[n].el_selected=!1;w.update(d.data)};g.changeFilter=function(e,t){var r=!0,i=[];for(f in n[e])n[e][f]==t?r=!1:i.push(n[e][f]);r&&i.push(t);n[e]=i;g.updateData();return r};var w=d3.dispatch("update");d3.rebind(g,w,"on");return g};